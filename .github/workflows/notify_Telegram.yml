name: CI with Telegram Notification

on:
  workflow_dispatch:

jobs:
  # Dein eigentlicher Arbeits-Job
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Work
        run: |
          echo "Führe Skripte aus..."
          # exit 1 # Zum Testen von 'Failure' einkommentieren

  # Der dedizierte Benachrichtigungs-Job
  notify:
    needs: [build]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Send Telegram Status
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          TG_CHANNEL_ID: ${{ secrets.TG_CHANNEL_ID }}
          # Hier ziehen wir den Status des 'build' Jobs
          RESULT: ${{ needs.build.result }}
        run: |
          case "${RESULT}" in
            success)
              ICON=""
              TEXT="SUCCESS"
              ;;
            failure)
              ICON=""
              TEXT="FAILED"
              ;;
            cancelled)
              ICON=""
              TEXT="CANCELLED"
              ;;
            *)
              ICON="⚪"
              TEXT="UNKNOWN"
              ;;
          esac

          MESSAGE="${ICON} *Build Result:* ${TEXT}%0A*Workflow:* ${{ github.workflow }}%0A*User:* ${{ github.actor }}"

          curl -s -f -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
            -d "chat_id=${TG_CHANNEL_ID}" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=Markdown"
