name: Update Winget PackageList

on:
  workflow_dispatch:
  schedule:
    - cron: "23 11 * * 1,3,5" # MO, MI, FR 12:23 MEZ (UTC+1)

permissions:
  contents: write   # notwendig für Releases

jobs:
  run-script:
    runs-on: windows-latest
    timeout-minutes: 120

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Run Update-WingetPackageList
        shell: pwsh
        run: |
          ./Update-WingetPackageList.ps1

      - name: Create or Update Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Winget Package List (Auto)
          body: |
            Automatisch generierte Winget-Paketliste.
            Aktualisiert: MO / MI / FR um 12:23.
          files: |
            winget-db/AllWingetPackages.csv
            winget-db/AllWingetPackages.json
          prerelease: false
          draft: false
  
  # Der dedizierte Benachrichtigungs-Job
  notify:
    needs: [run-script]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Send Telegram Status
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          TG_CHANNEL_ID: ${{ secrets.TG_CHANNEL_ID }}
          # Hier ziehen wir den Status des 'build' Jobs
          RESULT: ${{ needs.run-script.result }}
        run: |
          case "${RESULT}" in
            success)
              ICON=""
              TEXT="SUCCESS"
              ;;
            failure)
              ICON=""
              TEXT="FAILED"
              ;;
            cancelled)
              ICON=""
              TEXT="CANCELLED"
              ;;
            *)
              ICON="⚪"
              TEXT="UNKNOWN"
              ;;
          esac

          MESSAGE="${ICON} *Build Result:* ${TEXT}%0A*Workflow:* ${{ github.workflow }}%0A*User:* ${{ github.actor }}"

          curl -s -f -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
            -d "chat_id=${TG_CHANNEL_ID}" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=Markdown"
